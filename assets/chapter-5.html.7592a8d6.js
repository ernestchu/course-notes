import{r as o,c,a as n,b as e,w as p,F as r,e as t,d as s,o as l}from"./app.bdc3a143.js";import{_ as i}from"./plugin-vue_export-helper.5a098b48.js";const u={},k=t(`<h1 id="design-of-client-software" tabindex="-1"><a class="header-anchor" href="#design-of-client-software" aria-hidden="true">#</a> Design of Client Software</h1><h2 id="identify-a-server" tabindex="-1"><a class="header-anchor" href="#identify-a-server" aria-hidden="true">#</a> Identify A Server</h2><p>For a client, the first thing is to identify where the server is. It has to know the <strong>IP address</strong> and the <strong>port number</strong> of the server&#39;s application program. There&#39;re typically three ways to identify a server</p><ol><li>Specify the server&#39;s address (IP &amp; port) in client&#39;s program at the compile time. <ul><li>Hard coded, when the server changes, the program needs to be recompiled</li></ul></li><li>Require user to supply an argument to identify server <ul><li>Blocking I/O</li></ul></li><li>Use procedures to look up the information of server. DNS.</li></ol><h3 id="look-up-domain-names" tabindex="-1"><a class="header-anchor" href="#look-up-domain-names" aria-hidden="true">#</a> Look up domain names</h3><p>Socket API provides two procedures to find a domain name</p><ul><li><code>inet_addr()</code>: Take a string taht contains a dotted decimal address and return the equivalent numerical IP address in binary</li><li><code>gethostbyname()</code>: Take a string that contains the domain name for a machine and return a <code>hostent</code> (host entity) structure</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>h_name<span class="token punctuation">;</span>       <span class="token comment">/* official host name */</span> 
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>h_aliases<span class="token punctuation">;</span>   <span class="token comment">/* other aliases */</span> 
    <span class="token keyword">int</span>  h_addrtype<span class="token punctuation">;</span>    <span class="token comment">/* address type */</span> 
    <span class="token keyword">int</span>  h_length<span class="token punctuation">;</span>      <span class="token comment">/* address length */</span> 
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>h_addr_list<span class="token punctuation">;</span> <span class="token comment">/* list of addresses */</span> 
    <span class="token comment">/* multiple addr if there&#39;re multiple inet interface on the host */</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">h_addr</span> <span class="token expression">h_addr_list<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </span><span class="token comment">/*backward compatible*/</span></span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>Example</strong></p><p>Find the IP address of CSE webpage</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">hostent</span> <span class="token operator">*</span>hptr<span class="token punctuation">;</span>
<span class="token keyword">char</span> <span class="token operator">*</span>name <span class="token operator">=</span> <span class="token string">&quot;www.cse.nsysu.edu.tw&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>hptr <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* IP address is now in hptr-&gt;h_addr */</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* error in name */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="move-from-ipv4-to-ipv6" tabindex="-1"><a class="header-anchor" href="#move-from-ipv4-to-ipv6" aria-hidden="true">#</a> Move from IPv4 to IPv6</h4><p>However, <code>gethostbyname()</code> and <code>gethostbyaddr()</code> only support IPv4. In IPv6 we use</p><ul><li><code>getaddrinfo()</code>: convert strings which represent hostname or IP addresses into a <strong>linked list</strong> of addrinfo structure.</li><li><code>freeaddrinfo()</code>: gracefully clear the linked list of addrinfo.</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span>             ai_flags<span class="token punctuation">;</span>
    <span class="token keyword">int</span>             ai_family<span class="token punctuation">;</span>
    <span class="token keyword">int</span>             ai_socktype<span class="token punctuation">;</span>
    <span class="token keyword">int</span>             ai_protocol<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span>          ai_addrlen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span>ai_addr<span class="token punctuation">;</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>ai_canonname<span class="token punctuation">;</span>  <span class="token comment">/* canonical name */</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>ai_next<span class="token punctuation">;</span>       <span class="token comment">/* this forms a linked list */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h4 id="get-domain-name" tabindex="-1"><a class="header-anchor" href="#get-domain-name" aria-hidden="true">#</a> Get domain name</h4><p><strong>getnameinfo procedure</strong></p><p><code>getnameinfo()</code> converts binary IP addres (<code>struct sockaddr</code>) into test strings consisting of a hostname and service (judging from well-kown ports)</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span>   <span class="token operator">*</span>sa<span class="token punctuation">,</span>
    <span class="token class-name">socklen_t</span>               salen<span class="token punctuation">,</span>
    <span class="token keyword">char</span><span class="token operator">*</span>                   host<span class="token punctuation">,</span>
    <span class="token class-name">size_t</span>                  hostlen<span class="token punctuation">,</span>
    <span class="token keyword">char</span><span class="token operator">*</span>                   serv<span class="token punctuation">,</span>
    <span class="token class-name">size_t</span>                  <span class="token class-name">size_t</span> servlen<span class="token punctuation">,</span>
    <span class="token keyword">int</span>                     flags
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>Get all domain names on a host</strong></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NI_MAXHOST</span> <span class="token expression"><span class="token number">1025</span></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>result<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> error<span class="token punctuation">;</span>

    <span class="token comment">/* resolve the domain name into a list of addresses */</span>
    error <span class="token operator">=</span> <span class="token function">getaddrinfo</span><span class="token punctuation">(</span><span class="token string">&quot;www.cse.nsysu.edu.tw&quot;</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;error: %s\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* loop over all the results in the linked list and do inverse lookup */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>res <span class="token operator">=</span> result<span class="token punctuation">;</span> res <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> res <span class="token operator">=</span> res<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> hostname<span class="token punctuation">[</span>NI_MAXHOST<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

        error <span class="token operator">=</span> <span class="token function">getnameinfo</span><span class="token punctuation">(</span>res<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> NI_MAXHOST<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;error: %s\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">gai_strerror</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">/* look for the next item */</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>hostname <span class="token operator">!=</span> <span class="token string">&#39;\\0&#39;</span><span class="token punctuation">)</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;hostname: %s\\n&quot;</span><span class="token punctuation">,</span> hostname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="look-up-ports" tabindex="-1"><a class="header-anchor" href="#look-up-ports" aria-hidden="true">#</a> Look up ports</h3><p>Socket API provides a procedure to lookup a <strong>well-known</strong> port based on service and protocol</p><ul><li><code>getservbyname()</code>: require two string arguments (service and protocol) and return a <code>servent</code> (service entity) structure.</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">servent</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>s_name<span class="token punctuation">;</span>       <span class="token comment">/* official service name */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>s_aliases<span class="token punctuation">;</span>   <span class="token comment">/* other aliases */</span>
    <span class="token keyword">int</span>  s_port<span class="token punctuation">;</span>        <span class="token comment">/* port for this service */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>s_proto<span class="token punctuation">;</span>      <span class="token comment">/* protocol to use */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-container warning"><p class="custom-container-title">Remarks</p><p>Q. Why do we have to lookup for the port number if it is <strong>well-know</strong>?</p><p>A. The port number depends on the configuration on the remote host, e.g. https on the destination computer need not on port 443</p></div><p><strong>Example</strong> If the argument <code>protocol</code> is set to NULL, then any protocol will be matched</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">servent</span> <span class="token operator">*</span>sptr<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>sptr <span class="token operator">=</span> <span class="token function">getservbyname</span><span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* port number is now in sptr-&gt;s_port */</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* error occurred */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="look-up-protocol" tabindex="-1"><a class="header-anchor" href="#look-up-protocol" aria-hidden="true">#</a> Look up protocol</h3><p>Socket API provides a procedure that allows a client (or server) to map a protocol name to the integer constant.</p><ul><li><code>getprotobyname()</code>: Take a string argument of protocol name and return a protoent (protocol entity) structure</li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">protoent</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p_name<span class="token punctuation">;</span>       <span class="token comment">/* official protocol name */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>p_aliases<span class="token punctuation">;</span>   <span class="token comment">/* list of aliases allowed */</span>
    <span class="token keyword">int</span>  p_proto<span class="token punctuation">;</span>       <span class="token comment">/* official protocol number */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>Example</strong> Get the protocol information</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">protoent</span> <span class="token operator">*</span>pptr<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>pptr <span class="token operator">=</span> <span class="token function">getprotobyname</span><span class="token punctuation">(</span><span class="token string">&quot;udp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* official protocol number is now in pptr-&gt;p_proto */</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">/* error occurred */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="tcp-client-programming" tabindex="-1"><a class="header-anchor" href="#tcp-client-programming" aria-hidden="true">#</a> TCP Client Programming</h2><ol><li>Find IP address and port number of the server</li><li>Allocate a socket</li><li>Specify that the connection needs an unused protocol port and allow TCP to choose automatically</li><li>Connect the socket to the server</li><li>Communicate with the server <ul><li>Send requests and await replies</li></ul></li><li>Close the connection</li></ol><h3 id="make-a-connection" tabindex="-1"><a class="header-anchor" href="#make-a-connection" aria-hidden="true">#</a> Make a connection</h3><p><strong>Allocate a socket</strong></p>`,38),d=s("Recall "),m=s("chapter 3"),b=t(`<div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> fd<span class="token punctuation">;</span>

fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* PF_INET == AF_INET */</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>Select a local port</strong></p><p>A TCP client can arbitrarily select a local port as long as</p><ul><li>This port isn&#39;t used by another process</li><li>This port hasn&#39;t been assigned to a well-known service</li></ul><p><strong>Connect to a server</strong></p>`,5),h=s("Recall "),g=s("chapter 3"),y=s("For a TCP client, "),f=n("code",null,"connect()",-1),w=s(" forces initial TCP "),v=n("strong",null,"three-way handshaking",-1),_=s(". It has four major tasks"),x=n("ol",null,[n("li",null,[s("Ensure the specified socket has not already been connected "),n("ul",null,[n("li",null,"If so, gracefully close the previous connection first then proceed")])]),n("li",null,"Set the remote endpoint (IP & port) with passed arguments"),n("li",null,"Set the local endpoint (IP & port) automatically"),n("li",null,"Initiate a TCP three-way handshaking and return a value indicating the connection established or not")],-1),P=n("h3",{id:"communication",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#communication","aria-hidden":"true"},"#"),s(" Communication")],-1),q=s("Recall "),T=s("chapter 3"),C=t(`<div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BLEN</span> <span class="token expression"><span class="token number">120</span>    </span><span class="token comment">/* buffer length */</span></span>
<span class="token keyword">char</span> <span class="token operator">*</span>req <span class="token operator">=</span> <span class="token string">&quot;request for some port&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BLEN<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">/* buffer for result */</span>
<span class="token keyword">char</span> <span class="token operator">*</span>bptr<span class="token punctuation">;</span>         <span class="token comment">/* pointer to buffer */</span>
<span class="token keyword">int</span>  n<span class="token punctuation">;</span>             <span class="token comment">/* number of bytes read */</span>
<span class="token keyword">int</span>  buflen<span class="token punctuation">;</span>        <span class="token comment">/* space left in buffer */</span>

bptr    <span class="token operator">=</span> buf<span class="token punctuation">;</span>
buflen  <span class="token operator">=</span> BLEN

<span class="token comment">/* send request */</span>
<span class="token comment">/* write() == send() with the last argument equals 0 */</span>
<span class="token function">send</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> req<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* read() == recv() with the last argument equals 0 */</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> bptr<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    bptr <span class="token operator">+=</span> n<span class="token punctuation">;</span>
    bufflen <span class="token operator">-=</span> n<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>Since TCP is stream-oriented, it may choose to <strong>break a block</strong> of data into pieces and transmit each piece in a separate segment. So the receiver must be prepared to accept data a few bytes at a time.</p><h3 id="close-connection" tabindex="-1"><a class="header-anchor" href="#close-connection" aria-hidden="true">#</a> Close connection</h3>`,3),I=s("Recall "),N=s("chapter 2"),D=s("."),E=t(`<p><strong>shutdown procedure</strong></p><p>Socket API provides a procedure <code>shutdown()</code> to shut down a TCP connection in <strong>one or both</strong> direction, i.e., partial close.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>errcode <span class="token operator">=</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><ul><li><code>direction=0</code>: No futher receptions (input) is allowed</li><li><code>direction=1</code>: No futher transmissions (output) is allowed</li><li><code>direction=2</code>: Connection is shutdown in both directions <ul><li>Same as <code>close(fd)</code>, the remote host would receive an EOF hence close the connection remotely.</li></ul></li></ul><h2 id="udp-client-programming" tabindex="-1"><a class="header-anchor" href="#udp-client-programming" aria-hidden="true">#</a> UDP Client Programming</h2><h3 id="udp-sockets" tabindex="-1"><a class="header-anchor" href="#udp-sockets" aria-hidden="true">#</a> UDP sockets</h3><p>UDP socket has two modes</p><ol><li>connected <ul><li>Call <code>connect()</code> to specify a remote endpoint only once <ul><li><code>connect()</code> only records the endpoint&#39;s info for later use</li><li>The success of <code>connect()</code> does not mean the endpoint is valid or reachable</li></ul></li><li>No need to specify a remote host later</li><li>However, the endpoint is unawared of that at all</li></ul></li><li>unconnected <ul><li>Specify the destination each time when sending messages</li><li>This is flexible when you want to communicate with multiple servers with a single port</li></ul></li></ol><h3 id="communication-1" tabindex="-1"><a class="header-anchor" href="#communication-1" aria-hidden="true">#</a> Communication</h3><p>Unlike TCP, UDP provides message transfer, by which it transfer the entire message at once but do not guarantee the integrity of the data. So there&#39;s no need to make repeated calls to <code>recv()</code>. Of course, you need to have a buffer with sufficient space, otherwise UDP <strong>discards bytes</strong> that do not fit in the buffer.</p><h3 id="close-a-udp-socket" tabindex="-1"><a class="header-anchor" href="#close-a-udp-socket" aria-hidden="true">#</a> Close a UDP socket</h3><p>UDP client can call <code>close()</code> to close a socket file descriptor and release resource associated with it. But this call does not inform the server that the socket is closed.</p><h2 id="examples-of-network-services" tabindex="-1"><a class="header-anchor" href="#examples-of-network-services" aria-hidden="true">#</a> Examples of Network Services</h2><h3 id="connnecttcp-connectudp" tabindex="-1"><a class="header-anchor" href="#connnecttcp-connectudp" aria-hidden="true">#</a> connnectTCP &amp; connectUDP</h3><p>Create some procedures that we can reuse to make TCP or UDP connection.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code>socket <span class="token operator">=</span> <span class="token function">connectTCP</span><span class="token punctuation">(</span>machine<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
socket <span class="token operator">=</span> <span class="token function">connectUDP</span><span class="token punctuation">(</span>machine<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="connecttcp-procedure" tabindex="-1"><a class="header-anchor" href="#connecttcp-procedure" aria-hidden="true">#</a> connectTCP procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">connectsock</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>transport
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * connectTCP: Connect to a TCP service on a host
 * [Arguments]
 *  host:    Name of host to which connection is desired
 *  service: Service associated with the desired port
 */</span>

<span class="token keyword">int</span> <span class="token function">connectTCP</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">connectsock</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token string">&quot;tcp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="connectudp-procedure" tabindex="-1"><a class="header-anchor" href="#connectudp-procedure" aria-hidden="true">#</a> connectUDP procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">connectsock</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>transport
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * connectUDP: Connect to a UDP service on a host
 * [Arguments]
 *  host:    Name of host to which connection is desired
 *  service: Service associated with the desired port
 */</span>

<span class="token keyword">int</span> <span class="token function">connectUDP</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">connectsock</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token string">&quot;udp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="connectsock-procedure" tabindex="-1"><a class="header-anchor" href="#connectsock-procedure" aria-hidden="true">#</a> connectsock procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netdb.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">INADDR_NONE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INADDR_NONE</span> <span class="token expression"><span class="token number">0xffffffff</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* INADDR_NONE */</span></span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> errno<span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * connetsock: Allocate &amp; connect a socket using TCP or UDP
 * [Arguments]
 *  host:       Name of host to which connection is desired
 *  service:    Service associated with the desired port
 *  transport:  Name of transport protocol to use (&quot;tcp&quot; or &quot;udp&quot;)
 */</span>

<span class="token keyword">int</span> <span class="token function">connectsock</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>transport
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> <span class="token class-name">hostent</span>      <span class="token operator">*</span>phe<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">servent</span>      <span class="token operator">*</span>pse<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">protoent</span>     <span class="token operator">*</span>ppe<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span>  sin<span class="token punctuation">;</span>    <span class="token comment">/* an Internet endpoint address */</span>
    <span class="token keyword">int</span> s<span class="token punctuation">,</span> type<span class="token punctuation">;</span>

    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">/* clear sin */</span>
    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>

    <span class="token comment">/* Map service name to port number, allowing for number directly */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pse <span class="token operator">=</span> <span class="token function">getservbyname</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sin<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> pse<span class="token operator">-&gt;</span>s_port<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sin<span class="token punctuation">.</span>sinport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u_short<span class="token punctuation">)</span><span class="token function">atoi</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t get \\&quot;%s\\&quot; service entry\\n&quot;</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Map host name to IP address, allowing for dotted decimal */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>phe <span class="token operator">=</span> <span class="token function">gethostbyname</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">,</span> phe<span class="token operator">-&gt;</span>h_addr<span class="token punctuation">,</span> phe<span class="token operator">-&gt;</span>h_length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> INADDR_NONE<span class="token punctuation">)</span>
        <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t get \\&quot;%s\\&quot; host entry\\n&quot;</span><span class="token punctuation">,</span> host<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Map protocol name to protocol number */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ppe <span class="token operator">=</span> <span class="token function">getprotobyname</span><span class="token punctuation">(</span>transport<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t get \\&quot;%s\\&quot; protocol entry\\n&quot;</span><span class="token punctuation">,</span> transport<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Use protocol to choose a socket type */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>transport<span class="token punctuation">,</span> <span class="token string">&quot;udp&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        type <span class="token operator">=</span> SOCK_DGRAM<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        type <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>

    <span class="token comment">/* Allocate a socket */</span>
    s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> type<span class="token punctuation">,</span> ppe<span class="token operator">-&gt;</span>p_proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t create socket: %s\\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Connect the socket */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token string">&quot;can&#39;t connect to %s:%s: %s\\n&quot;</span><span class="token punctuation">,</span> host<span class="token punctuation">,</span> service<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><h4 id="errexit-procedure" tabindex="-1"><a class="header-anchor" href="#errexit-procedure" aria-hidden="true">#</a> errexit procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdarg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>

<span class="token comment">/*
 * errexit: Print an error message and exit
 */</span>

<span class="token keyword">int</span> <span class="token function">errexit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    va_list args<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vfprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="daytime-srevice" tabindex="-1"><a class="header-anchor" href="#daytime-srevice" aria-hidden="true">#</a> DAYTIME srevice</h3><ul><li>It allows users to obtain the date and time in a format fit for human consumption <ul><li>E.g. &quot;Tue Apr 20 21:19:39 CST 2021&quot;</li></ul></li><li>DAYTIME supports both TCP and UDP connections, and operates at <strong>port 13</strong></li></ul><h4 id="two-types-of-connections" tabindex="-1"><a class="header-anchor" href="#two-types-of-connections" aria-hidden="true">#</a> Two types of connections</h4><ol><li>TCP connection <ul><li>TCP client does not need to send any request</li><li>Once a new connection arrives, the server <ol><li>Form a string containing the current data and time</li><li>Send the string</li><li>Close the connection</li></ol></li></ul></li><li>UDP connection <ul><li>UDP client needs to send a request, which can be any UDP datagram</li><li>Once receiving a datagramn the server <ol><li>Do the first two things same as TCP server</li><li>Once it has sent a reply, the server discards the datagram received</li></ol></li></ul></li></ol><h4 id="dattime-tcp-client" tabindex="-1"><a class="header-anchor" href="#dattime-tcp-client" aria-hidden="true">#</a> DATTIME TCP-client</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">TCPdaytime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">connectTCP</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LINELEN</span> <span class="token expression"><span class="token number">128</span></span></span>

<span class="token comment">/* DAYTIME client&#39;s main function */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>host <span class="token operator">=</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">;</span>   <span class="token comment">/* host to use if none supplied */</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>service <span class="token operator">=</span> <span class="token string">&quot;daytime&quot;</span><span class="token punctuation">;</span>  <span class="token comment">/* default service port */</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>argc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
            service <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            host <span class="token operator">=</span> argb<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;usage: TCPdaytime [host [port]]\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">TCPdaytime</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * TCPdaytime: Invoke Daytime on specified host and print results
 */</span>
<span class="token keyword">void</span> <span class="token function">TCPdaytime</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>host<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>srevice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>LINELEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* buffer for one line of text */</span>
    <span class="token keyword">int</span> s<span class="token punctuation">,</span> n<span class="token punctuation">;</span>               <span class="token comment">/* socket, read count */</span>

    s <span class="token operator">=</span> <span class="token function">connectTCP</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> LINELEN<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        buf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;\\0&#39;</span><span class="token punctuation">;</span>      <span class="token comment">/* ensure null-terminated */</span>
        <span class="token function">fputs</span><span class="token punctuation">(</span>bif<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><h3 id="time-service" tabindex="-1"><a class="header-anchor" href="#time-service" aria-hidden="true">#</a> TIME service</h3><p>It specifies time in a 32-bit integer which represents the number of seconds since midnight, January 1, 1970, UCT</p><p>TIME protocol supports both TCP and UDP connections, and operates at protocol port 37. The mechanism is similar to that of DAYTIME service.</p><h3 id="echo-service" tabindex="-1"><a class="header-anchor" href="#echo-service" aria-hidden="true">#</a> ECHO service</h3>`,34);function S(A,U){const a=o("RouterLink");return l(),c(r,null,[k,n("p",null,[d,e(a,{to:"/courses/cse491-network-application-programming/chapter-3.html#socket-procedure"},{default:p(()=>[m]),_:1})]),b,n("p",null,[h,e(a,{to:"/courses/cse491-network-application-programming/chapter-3.html#connect-procedure"},{default:p(()=>[g]),_:1})]),n("p",null,[y,f,w,e(a,{to:"/courses/cse491-network-application-programming/chapter-2.html#connection-management"},{default:p(()=>[v]),_:1}),_]),x,P,n("p",null,[q,e(a,{to:"/courses/cse491-network-application-programming/chapter-3.html#write-procedure"},{default:p(()=>[T]),_:1})]),C,n("p",null,[I,e(a,{to:"/courses/cse491-network-application-programming/chapter-2.html#connection-management"},{default:p(()=>[N]),_:1}),D]),E],64)}var O=i(u,[["render",S]]);export{O as default};
