<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>UNIX Socket Programming | Ernie's course notes</title><meta name="description" content="Thank you for visiting my course notes">
    <link rel="modulepreload" href="/course-notes/assets/app.bdc3a143.js"><link rel="modulepreload" href="/course-notes/assets/chapter-3.html.ec1ee5a5.js"><link rel="modulepreload" href="/course-notes/assets/plugin-vue_export-helper.5a098b48.js"><link rel="modulepreload" href="/course-notes/assets/chapter-3.html.681eea53.js">
    <link rel="stylesheet" href="/course-notes/assets/style.28fc8010.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/course-notes/" class=""><!----><span class="site-name">Ernie&#39;s course notes</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/course-notes/courses/cse350-computer-network/" class="nav-link" aria-label="CSE350 Computer Network"><!--[--><!--]--> CSE350 Computer Network <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse365-unix-system-programming/" class="nav-link" aria-label="CSE365 Unix System Programming"><!--[--><!--]--> CSE365 Unix System Programming <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse360-design-and-implementation-of-compiler/" class="nav-link" aria-label="CSE360 Design and Implementation of Compiler"><!--[--><!--]--> CSE360 Design and Implementation of Compiler <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse491-network-application-programming/" class="nav-link router-link-active" aria-label="CSE491 Network Application Programming"><!--[--><!--]--> CSE491 Network Application Programming <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/ernestchu/course-notes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/course-notes/courses/cse350-computer-network/" class="nav-link" aria-label="CSE350 Computer Network"><!--[--><!--]--> CSE350 Computer Network <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse365-unix-system-programming/" class="nav-link" aria-label="CSE365 Unix System Programming"><!--[--><!--]--> CSE365 Unix System Programming <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse360-design-and-implementation-of-compiler/" class="nav-link" aria-label="CSE360 Design and Implementation of Compiler"><!--[--><!--]--> CSE360 Design and Implementation of Compiler <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/course-notes/courses/cse491-network-application-programming/" class="nav-link router-link-active" aria-label="CSE491 Network Application Programming"><!--[--><!--]--> CSE491 Network Application Programming <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/ernestchu/course-notes" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">UNIX Socket Programming</p><ul class=""><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#preliminary" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Preliminary"><!--[--><!--]--> Preliminary <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#transportation-layer-protocols" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Transportation-layer protocols"><!--[--><!--]--> Transportation-layer protocols <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#port" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Port"><!--[--><!--]--> Port <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#ip-address" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="IP address"><!--[--><!--]--> IP address <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#basic-socket-i-o" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Basic Socket I/O"><!--[--><!--]--> Basic Socket I/O <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#tcp-server" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="TCP server"><!--[--><!--]--> TCP server <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#tcp-client" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="TCP client"><!--[--><!--]--> TCP client <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#udp-server" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="UDP server"><!--[--><!--]--> UDP server <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#udp-client" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="UDP client"><!--[--><!--]--> UDP client <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#advanced-socket-i-o" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Advanced Socket I/O"><!--[--><!--]--> Advanced Socket I/O <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/course-notes/courses/cse491-network-application-programming/chapter-3.html#simultaneous-udp-server" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Simultaneous UDP server"><!--[--><!--]--> Simultaneous UDP server <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="unix-socket-programming" tabindex="-1"><a class="header-anchor" href="#unix-socket-programming" aria-hidden="true">#</a> UNIX Socket Programming</h1><h2 id="preliminary" tabindex="-1"><a class="header-anchor" href="#preliminary" aria-hidden="true">#</a> Preliminary</h2><p>Server and client exchange messages over network through a common <a href="/course-notes/courses/cse491-network-application-programming/chapter-2.html#internet-socket" class="">socket API</a></p><h3 id="transportation-layer-protocols" tabindex="-1"><a class="header-anchor" href="#transportation-layer-protocols" aria-hidden="true">#</a> Transportation-layer protocols</h3><h4 id="udp" tabindex="-1"><a class="header-anchor" href="#udp" aria-hidden="true">#</a> UDP</h4><ul><li>Single socket to receive messages</li><li>No guarantee of delivery</li><li>Not necessarily in-order delivery</li><li><strong>Datagram</strong><ul><li>Independent packets</li></ul></li><li>Must address each packet</li><li>Examples <ul><li>Multimedia</li><li>VoIP</li></ul></li></ul><h4 id="tcp" tabindex="-1"><a class="header-anchor" href="#tcp" aria-hidden="true">#</a> TCP</h4><ul><li>Connection-oriented, dedicated socket for each connection</li><li>Reliable, ensuring delivery</li><li>Byte <strong>stream</strong>, in-order delivery</li><li>Setup connection before data transfer</li><li>Examples <ul><li>Web</li><li>email</li><li>ssh</li></ul></li></ul><h3 id="port" tabindex="-1"><a class="header-anchor" href="#port" aria-hidden="true">#</a> Port</h3><p>A host can have up to 2<sup>16</sup> ports and they&#39;re used by different processes on the host. The port numbers are used to identify entities (processes) on a host. Port numbers can be</p><ol><li>Well-known (ports 0 ~ 1023)</li><li>Registered (ports 1024 ~ 49151) <ul><li>can be used by ordinary users</li></ul></li><li>Dynamic, private, or ephemeral (ports 49152 ~ 65535)</li></ol><ul><li><strong>Servers</strong> and <strong>daemons</strong> (medium between applications and the kernel) usually use well-known ports <ul><li>https: 443</li><li>ssh: 22</li></ul></li><li>Client usually use dynamic ports <ul><li>Assigned by the kernel at run time</li></ul></li></ul><h3 id="ip-address" tabindex="-1"><a class="header-anchor" href="#ip-address" aria-hidden="true">#</a> IP address</h3><p>Each attachment point on the Internet is assigned with a unique <strong>address</strong>. However, it hard for human to memorize the numeric addresses. Instead, we prefer to deal with names, hence the domain name server (DNS) provides the mapping of host names to their IP address.</p><h4 id="ipv4-internet-addressing" tabindex="-1"><a class="header-anchor" href="#ipv4-internet-addressing" aria-hidden="true">#</a> IPv4 Internet addressing</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token comment">/* Internet address structure */</span>
<span class="token keyword">struct</span> <span class="token class-name">in_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">in_addr_t</span> s_addr<span class="token punctuation">;</span>                   <span class="token comment">/* 32-bit IPv4 address */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/* Socket address */</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token punctuation">{</span>
    u_char          sin_len<span class="token punctuation">;</span>            <span class="token comment">/* length (16, optional) */</span>
    u_short         sin_family<span class="token punctuation">;</span>         <span class="token comment">/* address family (AF_INET) &lt;- v4 */</span>
    u_short         sin_port<span class="token punctuation">;</span>           <span class="token comment">/* UDP or TCP port */</span>

    <span class="token keyword">struct</span> <span class="token class-name">in_addr</span>  sin_addr<span class="token punctuation">;</span>           <span class="token comment">/* IP address */</span>
    <span class="token keyword">char</span>            sin_zero<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment">/* unused (padding) */</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="ipv6-internet-addressing" tabindex="-1"><a class="header-anchor" href="#ipv6-internet-addressing" aria-hidden="true">#</a> IPv6 Internet addressing</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token comment">/* Internet address structure */</span>
<span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> <span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> s6_addr<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment">/* 128-bit IPv6 address */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SIN6_LEN</span>                       <span class="token comment">/* required for compile-time tests */</span></span>

<span class="token comment">/* Socket address */</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in6</span> <span class="token punctuation">{</span>
    <span class="token class-name">sa_family_t</span>     sin6_family<span class="token punctuation">;</span>        <span class="token comment">/* AF_INET6 &lt;- v4 */</span>
    <span class="token class-name">in_port_t</span>       sin6_port<span class="token punctuation">;</span>          <span class="token comment">/* transport layer port num */</span>
    <span class="token class-name">uint32_t</span>        sin6_flowinfo<span class="token punctuation">;</span>      <span class="token comment">/* IPv6 flow information */</span>
    <span class="token keyword">struct</span> <span class="token class-name">in6_addr</span> sin6_addr<span class="token punctuation">;</span>          <span class="token comment">/* IPv6 address */</span>
    <span class="token comment">/* set of interfaces for a scope */</span>
    <span class="token class-name">uint32_t</span>        sin6_scope_id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h4 id="byte-ordering" tabindex="-1"><a class="header-anchor" href="#byte-ordering" aria-hidden="true">#</a> Byte ordering</h4><p>The endianess (big/little) may be different between hosts, so we should use a byte-ordering translation procedure to maintain the compatibility.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token class-name">uint32_t</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> hostlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> hostshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> <span class="token function">ntohl</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> netlong<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> <span class="token function">ntohs</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> netshort<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><strong>h</strong>: host byte order</li><li><strong>n</strong>: network (remote) byte order</li><li><strong>l</strong>: long (4 bytes), used to convert IP addresses</li><li><strong>s</strong>: short (2 bytes), used to convert port numbers</li></ul><h4 id="unix-data-types" tabindex="-1"><a class="header-anchor" href="#unix-data-types" aria-hidden="true">#</a> UNIX data types</h4><table><tr><th>Datatype</th><th>Description</th><th>Header</th></tr><tr><td>int8_t</td><td>Unsigned 8-bit integer</td><td rowspan="6">&lt;sys/types.h&gt;</td></tr><tr><td>uint8_t</td><td>Signed 16-bit integer</td></tr><tr><td>int16_t</td><td>Signed 16-bit integer</td></tr><tr><td>uint16_t</td><td>Unsigned 16-bit integer</td></tr><tr><td>int32_t</td><td>Signed 32-bit integer</td></tr><tr><td>uint32_t</td><td>Unsigned 32-bit integer</td></tr><tr><td>sa_family_t</td><td>Address family of socket address structure</td><td rowspan="2">&lt;sys/socket.h&gt;</td></tr><tr><td>socklen_t</td><td>Length of socket address structure, normally uint32_t</td></tr><tr><td>in_addr_t</td><td>IPv4 address, normally uint32_t</td><td rowspan="2">&lt;netinet/in.h&gt;</td></tr><tr><td>in_port_t</td><td>TCP or UDP port, normally uint16_t</td></tr></table><h2 id="basic-socket-i-o" tabindex="-1"><a class="header-anchor" href="#basic-socket-i-o" aria-hidden="true">#</a> Basic Socket I/O</h2><p>Socket is a <strong>file descriptor</strong> which allows an application to read/write data from/to the network.</p><div class="custom-container tip"><p class="custom-container-title">File Descriptor</p><p>In Unix, all of the I/O are treated as files stream, where <code>stdin</code>, <code>stdout</code> and <code>stderr</code> are mapped to <code>0</code>, <code>1</code> and <code>2</code> in the file descriptor table respectively.</p></div><h3 id="tcp-server" tabindex="-1"><a class="header-anchor" href="#tcp-server" aria-hidden="true">#</a> TCP server</h3><p>TCP establishes connection before each host can transmit data. We require a serial of procedures to build up a TCP server</p><ol><li><a href="#socket-procedure">socket()</a>: Get the <strong>file descriptor</strong>.</li><li><a href="#bind-procedure">bind()</a>: Connect the file descriptor with <strong>IP</strong> and <strong>port</strong>.</li><li><a href="#listen-procedure">listen()</a>: <strong>Wait</strong> for request from clients.</li><li><a href="#accept-procedure">accept()</a>: <strong>Accept</strong> request.</li><li><a href="#read-procedure">read()</a>: Read data from the socket.</li></ol><h4 id="socket-procedure" tabindex="-1"><a class="header-anchor" href="#socket-procedure" aria-hidden="true">#</a> socket procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><code>socket()</code> returns the file descriptor <ul><li>A negative value indicates an error</li></ul></li><li><code>family</code><ul><li><code>AF_INET</code> for IPv4</li><li><code>AF_INET6</code> for IPv6</li></ul></li><li><code>type</code><ul><li><code>SOCK_STREAM</code>, typically TCP</li><li><code>SOCK_DGRAMm</code> typically UDP</li></ul></li><li><code>protocol</code>, if not compatible with <code>type</code>, then default to TCP or UDP based on <code>type</code><ul><li><code>IPPROTO_TCP</code></li><li><code>IPPROTO_UDP</code></li><li>...</li></ul></li></ul><h4 id="bind-procedure" tabindex="-1"><a class="header-anchor" href="#bind-procedure" aria-hidden="true">#</a> bind procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>

srv<span class="token punctuation">.</span>sin_family      <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>              <span class="token comment">/* IPv4*/</span>
srv<span class="token punctuation">.</span>sin_port        <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* listen on port 80 */</span>
srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* listen on all of the network interface */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="listen-procedure" tabindex="-1"><a class="header-anchor" href="#listen-procedure" aria-hidden="true">#</a> listen procedure</h4><p>When a socket is created by <code>socket()</code>, it default to a <strong>active</strong> socket. Then <code>listen()</code> procedure converts it to a <strong>passive</strong> socket, so kernel can accept incoming connection directed to this socket.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BACKLOG</span> <span class="token expression"><span class="token operator">=</span> <span class="token number">5</span>     </span><span class="token comment">/* This specifies the max #connections that kernel should queue for this socket */</span></span>
<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>
<span class="token comment">/* 2) bind the socket to a port by bind() */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> BACKLOG<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;listen&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Here the connection is not established yet! We just store the requests in a queue. The size of the queue depends on <code>BACKLOG</code></p><div class="custom-container danger"><p class="custom-container-title">Backlog of Zero</p><p>If you do not want any client to connect to your socket, just <strong>close</strong> the socket. The backlog is a <strong>pseudo</strong> size. A backlog of zero do not set the number of queued connections to zero.</p></div><h4 id="accept-procedure" tabindex="-1"><a class="header-anchor" href="#accept-procedure" aria-hidden="true">#</a> accept procedure</h4><p><code>accept()</code> blocks waiting for a connection, and if there&#39;s request, a connection is established. It returns a <strong>new socket</strong> (newfd, dedicated socket for the connection).</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>                     <span class="token comment">/* used by socket() */</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>     <span class="token comment">/* used by bind() */</span>

<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> cli<span class="token punctuation">;</span>     <span class="token comment">/* used by accept() */</span>
<span class="token keyword">int</span> newfd<span class="token punctuation">;</span>
<span class="token keyword">int</span> cli_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cli<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>
<span class="token comment">/* 2) bind the socket to a port by bind() */</span>
<span class="token comment">/* 3) listen on the socket */</span>

newfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>cli<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cli_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* The client may be IPv4 or IPv6, pass the references of client variables */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;accept&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><ul><li>Get the information of the client <ul><li><code>cli.sin_addr.s_addr</code> contains client&#39;s IP address</li><li><code>cli.sin_port</code> contains client&#39;s port number</li><li>Use <a href="#numerical-address-to-string">this</a> to extract the content.</li></ul></li><li>Then, the server can exchange data with the client by using <code>read()</code> and <code>write()</code> on the file descriptor <code>newfd</code></li></ul><h4 id="read-procedure" tabindex="-1"><a class="header-anchor" href="#read-procedure" aria-hidden="true">#</a> read procedure</h4><ul><li><code>read()</code> can be used to get data from a socket <ul><li><code>read()</code> blocks waiting for data from the client</li><li>It does <strong>not</strong> guarantee that a <code>sizeof(buf)</code> amount of data will be read</li><li>It returns #bytes transmitted</li></ul></li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFSIZE</span> <span class="token expression"><span class="token number">512</span></span></span>
inf newfd<span class="token punctuation">;</span>             <span class="token comment">/* dedicated fd */</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> nbytes<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>
<span class="token comment">/* 2) bind the socket to a port by bind() */</span>
<span class="token comment">/* 3) listen on the socket */</span>
<span class="token comment">/* 4) accept the incoming connection */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>newfd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;read&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="tcp-client" tabindex="-1"><a class="header-anchor" href="#tcp-client" aria-hidden="true">#</a> TCP client</h3><h4 id="deal-with-ip-address" tabindex="-1"><a class="header-anchor" href="#deal-with-ip-address" aria-hidden="true">#</a> Deal with IP address</h4><p>TCP client needs to know the IP address of the server. However, we use IP addresses as <strong>strings</strong> (with dot, right?) Meanwhile, The computers only recognize them as numbers. So we need a <strong>conversion procedure</strong> again.</p><h5 id="string-to-numerical-address" tabindex="-1"><a class="header-anchor" href="#string-to-numerical-address" aria-hidden="true">#</a> String to numerical address</h5><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;140.117.11.87&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">in_addr_t</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;inet_addr failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="numerical-address-to-string" tabindex="-1"><a class="header-anchor" href="#numerical-address-to-string" aria-hidden="true">#</a> Numerical address to string</h5><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

<span class="token keyword">char</span> <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;inet_ntoa failed!\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="connect-procedure" tabindex="-1"><a class="header-anchor" href="#connect-procedure" aria-hidden="true">#</a> connect procedure</h4><p><code>connect()</code> allows a client to connect with the server.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>

srv<span class="token punctuation">.</span>sin_family      <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_port        <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;140.117.11.87&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* specify the server IP */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;connect&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="write-procedure" tabindex="-1"><a class="header-anchor" href="#write-procedure" aria-hidden="true">#</a> write procedure</h4><p><code>write()</code> can be used to write data to a socket</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUFSIZE</span> <span class="token expression"><span class="token number">512</span></span></span>
<span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUFSIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> nbytes<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>
<span class="token comment">/* 2) connect() to the server */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nbytes <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;write&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="tcp-client-server-interaction" tabindex="-1"><a class="header-anchor" href="#tcp-client-server-interaction" aria-hidden="true">#</a> TCP client-server interaction</h4><p><img src="/course-notes/assets/figure-1.183873f6.png" alt="figure-1"></p><blockquote><p>Image credit to Professor Wang&#39;s slides</p></blockquote><h3 id="udp-server" tabindex="-1"><a class="header-anchor" href="#udp-server" aria-hidden="true">#</a> UDP server</h3><p>UDP uses a single socket for all the transmission We require a three procedures to build up a UDP server</p><ol><li><a href="#socket-procedure-2">socket()</a>: Get the <strong>file descriptor</strong>.</li><li><a href="#bind-procedure-2">bind()</a>: Connect the file descriptor with <strong>IP</strong> and <strong>port</strong>.</li><li><a href="#recvfrom-procedure">recvfrom()</a>: Receive data from the socket</li></ol><h4 id="socket-procedure-1" tabindex="-1"><a class="header-anchor" href="#socket-procedure-1" aria-hidden="true">#</a> socket procedure</h4><p>UDP server must create a <strong>datagram</strong> socket</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* we didn&#39;t specify the protocol, becuase SOCK_DGRAM default it to UDP */</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;socket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eixt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="bind-procedure-1" tabindex="-1"><a class="header-anchor" href="#bind-procedure-1" aria-hidden="true">#</a> bind procedure</h4><p>A socket can be bound to a port</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>

srv<span class="token punctuation">.</span>sin_family      <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_port        <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="recvfrom-procedure" tabindex="-1"><a class="header-anchor" href="#recvfrom-procedure" aria-hidden="true">#</a> recvfrom procedure</h4><p><code>read</code> does not provide client&#39;s addres to UDP server, but in UDP, every transmission need to specify the IP.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> cli<span class="token punctuation">;</span>
<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> cli_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cli<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> nbytes<span class="token punctuation">;</span>

<span class="token comment">/* 1) create the socket by socket() */</span>
<span class="token comment">/* 2) bind to the socket by bind() */</span>

nbyts <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>cli<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cli_len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;recvfrom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>Actoins performed by recvfrom() procedure</p><ol><li>Return the #bytes read, i.e., <code>nbytes</code>.</li><li>Copy a <code>nbytes</code> amount of data into <code>buf</code>.</li><li>Modified the address of the client, i.e., <code>cli</code>.</li><li>Modified the length of the client, i.e., <code>cli_len</code>.</li></ol><h3 id="udp-client" tabindex="-1"><a class="header-anchor" href="#udp-client" aria-hidden="true">#</a> UDP client</h3><ol><li>socket(): Get the <strong>file descriptor</strong>.</li><li>sendto(): Send data to the socket</li></ol><h4 id="sendto-procedure" tabindex="-1"><a class="header-anchor" href="#sendto-procedure" aria-hidden="true">#</a> sendto procedure</h4><p>UDP client does not bind a port number. A port number is dynamically assigned when the first <code>sendto()</code> procedure is invoked.</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> fd<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> srv<span class="token punctuation">;</span>

srv<span class="token punctuation">.</span>sin_family      <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_port        <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
srv<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">&quot;140.117.11.87&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

nbytes <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>srv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>srv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;sendto&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="udp-client-server-interaction" tabindex="-1"><a class="header-anchor" href="#udp-client-server-interaction" aria-hidden="true">#</a> UDP client-server interaction</h4><p><img src="/course-notes/assets/figure-2.e0ca2cf6.png" alt="figure-2"></p><blockquote><p>Image credit to Professor Wang&#39;s slides</p></blockquote><h2 id="advanced-socket-i-o" tabindex="-1"><a class="header-anchor" href="#advanced-socket-i-o" aria-hidden="true">#</a> Advanced Socket I/O</h2><h3 id="simultaneous-udp-server" tabindex="-1"><a class="header-anchor" href="#simultaneous-udp-server" aria-hidden="true">#</a> Simultaneous UDP server</h3><h4 id="a-naive-solution" tabindex="-1"><a class="header-anchor" href="#a-naive-solution" aria-hidden="true">#</a> A naive solution</h4><p>What&#39;s wrong with the following code</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">;</span>

<span class="token comment">/* create socket for s1, s2 and bind to ports */</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">recvfrom</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> buf1<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">recvfrom</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> buf2<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="custom-container tip"><p class="custom-container-title">Answer</p><p>If client <code>s1</code> never send data, the server would blocking wait for <code>s1</code> and would never have chance to receive data from <code>s2</code>.</p></div><h4 id="select-procedure" tabindex="-1"><a class="header-anchor" href="#select-procedure" aria-hidden="true">#</a> select procedure</h4><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span>
    <span class="token keyword">int</span> maxfds<span class="token punctuation">,</span> 
    fdset <span class="token operator">*</span>readfds<span class="token punctuation">,</span> 
    fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> 
    fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> 
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">FD_CLR</span>  <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* clear the bit for fd in fds */</span> 
<span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* is the bit for fd in fds? */</span> 
<span class="token function">FD_SET</span>  <span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>fds<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* turn on the bit for fd in fds */</span> 
<span class="token function">FD_ZERO</span> <span class="token punctuation">(</span>fd_set <span class="token operator">*</span>fds<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">/* clear all bits in fds */</span> 
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li><code>maxfds</code>: Number of descriptors to be tested <ul><li>fd (0, 1, ..., <code>maxfds-1</code>) will be tested.</li></ul></li><li><code>readfds</code>: Return a set of fds that are ready to read</li><li><code>writefds</code>: Return a set of fds that are ready to write</li><li><code>exceptfds</code>: Return a set of fds with exception conditions</li><li><code>timeout</code>: <ul><li>If it&#39;s NULL, then wait forever and return only when one of the fd is ready for I/O</li><li>Otherwise, wait up to <code>timeout</code></li><li>Or we can just specify it to 0 in a <strong>while loop</strong></li></ul></li></ul><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> s1<span class="token punctuation">,</span> s2<span class="token punctuation">;</span>
fd_set readfds<span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FD_ZERO</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span>       <span class="token comment">/* initialize the fd set */</span>
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* add s1 to the fd set */</span>
    <span class="token function">FD_SET</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">/* add s2 to the fd set */</span>

    <span class="token comment">/* use select() for synchronous I/O multiplexing */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">select</span><span class="token punctuation">(</span>s2<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* notice for s2 + 1 */</span>
        <span class="token comment">/* set one of the fd in (0, 1, ... s2) */</span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">&quot;select&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">recvfrom</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FD_ISSET</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>readfds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">recvfrom</span><span class="token punctuation">(</span>s2<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/ernestchu/course-notes/edit/main/docs/courses/cse491-network-application-programming/chapter-3.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--> Edit this page on GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><span class="meta-item-info">11/10/2021, 6:05:16 PM</span></div><div class="meta-item contributors"><span class="meta-item-label">Authors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: b073040018@nsysu.edu.tw">ernestchu</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/course-notes/assets/app.bdc3a143.js" defer></script>
  </body>
</html>
